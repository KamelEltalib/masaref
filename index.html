<!doctype html>    
<html lang="ar" dir="rtl">    
<head>    
  <meta charset="utf-8">    
  <meta name="viewport" content="width=device-width, initial-scale=1">    
  <title>Ø¥Ø¯Ø§Ø±Ø© Ù…ØµØ§Ø±ÙŠÙ Ø§Ù„Ø¨ÙŠØª</title>    
    
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">    
    
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">    
    
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">    
    
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>    
    
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>    
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>    
    
  <style>    
    :root {    
      --primary-color: #198754;    
      --primary-hover: #157347;    
      --danger-color: #dc3545;    
      --warning-color: #ffc107;    
      --light-bg: #f8f9fa;    
      --card-shadow: 0 2px 8px rgba(0,0,0,0.1);    
    }    
    
    body {    
      background-color: var(--light-bg);    
      font-family: 'Cairo', sans-serif;    
    }    
    .card {    
      border: none;    
      border-radius: 15px;    
      box-shadow: var(--card-shadow);    
      transition: transform 0.2s;    
    }    
    .card:hover {    
      transform: translateY(-2px);    
    }    
    .btn-green {    
      background-color: var(--primary-color);    
      color: #fff;    
    }    
    .btn-green:hover {    
      background-color: var(--primary-hover);    
      color: #fff; /* ØªØ£ÙƒØ¯ Ù…Ù† Ø¨Ù‚Ø§Ø¡ Ø§Ù„Ù„ÙˆÙ† Ø£Ø¨ÙŠØ¶ Ø¹Ù†Ø¯ Ø§Ù„ØªØ­ÙˆÙŠÙ… */    
    }    
    .expense-item {    
      background-color: #f1f3f4;    
      border-radius: 10px;    
      padding: 8px 10px;    
      margin-bottom: 6px;    
      display: flex;    
      justify-content: space-between;    
      align-items: center;    
      transition: background-color 0.2s;    
    }    
    .expense-item:hover {    
      background-color: #e8eaed;    
    }    
    .progress {    
      height: 8px;    
      margin: 5px 0;    
    }    
    .budget-summary {    
      background: linear-gradient(135deg, #198754, #20c997);    
      color: white;    
      border-radius: 10px;    
      padding: 15px;    
      margin-bottom: 15px;    
    }    
    .empty-state {    
      text-align: center;    
      padding: 30px;    
      color: #6c757d;    
    }    
    .empty-state i {    
      font-size: 3rem;    
      margin-bottom: 10px;    
      opacity: 0.5;    
    }    
    .budget-actions {    
      display: flex;    
      gap: 5px;    
      margin-top: 10px;    
    }    
    .budget-actions button {    
      flex: 1;    
    }    
    .expense-date {    
      font-size: 0.8rem;    
      color: #6c757d;    
    }    
    .category-badge {    
      font-size: 0.7rem;    
      padding: 2px 6px;    
      border-radius: 10px;    
      background-color: #e9ecef;    
    }    
    .chart-container {    
      height: 200px;    
      margin: 15px 0;    
    }    
    .nav-tabs .nav-link.active {    
      background-color: var(--primary-color);    
      color: white;    
      border: none;    
    }    
    .nav-tabs .nav-link {    
      color: var(--primary-color);    
    }    
    
    /* Ø¥ØµÙ„Ø§Ø­ ØµØºÙŠØ± Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø¨Ø­Ø« */    
    #expenseSearch {    
        border-top-left-radius: 0.375rem !important; /* Ù„Ø¶Ù…Ø§Ù† Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ ÙÙŠ RTL */    
        border-bottom-left-radius: 0.375rem !important; /* Ù„Ø¶Ù…Ø§Ù† Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ ÙÙŠ RTL */    
        border-top-right-radius: 0 !important;    
        border-bottom-right-radius: 0 !important;    
    }    
  </style>    
</head>    
<body>    
  <div class="container py-4">    
    <div class="text-center mb-4">    
      <h2 class="fw-bold text-success">ğŸ’° Ø¥Ø¯Ø§Ø±Ø© Ù…ØµØ§Ø±ÙŠÙ Ø§Ù„Ø¨ÙŠØª</h2>    
      <p class="text-muted">ØªØ·Ø¨ÙŠÙ‚ Ø¨Ø³ÙŠØ· Ù„Ø¥Ø¯Ø§Ø±Ø© Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø§Ù„Ù…Ù†Ø²Ù„ ÙˆØªØªØ¨Ø¹ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</p>    
    </div>    
    
    <div class="card p-3 mb-4">    
      <h5 class="fw-bold mb-3"><i class="bi bi-wallet2"></i> Ø¥Ù†Ø´Ø§Ø¡ Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø©</h5>    
      <div class="row g-2">    
        <div class="col-md-4">    
          <select id="budgetType" class="form-select">    
            <option value="ÙŠÙˆÙ…ÙŠ">ÙŠÙˆÙ…ÙŠ</option>    
            <option value="Ø£Ø³Ø¨ÙˆØ¹ÙŠ">Ø£Ø³Ø¨ÙˆØ¹ÙŠ</option>    
            <option value="Ø´Ù‡Ø±ÙŠ" selected>Ø´Ù‡Ø±ÙŠ</option>    
          </select>    
        </div>    
        <div class="col-md-4">    
          <input id="budgetLabel" type="text" class="form-control" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© (Ù…Ø«Ù„Ø§Ù‹: Ø£ÙƒØªÙˆØ¨Ø± 2025)">    
        </div>    
        <div class="col-md-4">    
          <input id="budgetTotal" type="number" class="form-control" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„ÙƒÙ„ÙŠ (Ø¬.Ø³)">    
        </div>    
      </div>    
      <button class="btn btn-green w-100 mt-3" onclick="addBudget()">    
        <i class="bi bi-check-circle"></i> Ø­ÙØ¸ Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©    
      </button>    
    </div>    
    
    <div class="card p-3 mb-4">    
      <div class="d-flex justify-content-between align-items-center mb-3">    
        <h5 class="fw-bold mb-0"><i class="bi bi-list-ul"></i> Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ§Øª</h5>    
        <div>    
          <button class="btn btn-sm btn-outline-secondary" onclick="toggleView()" id="toggleViewBtn">    
            <i class="bi bi-grid"></i> Ø¹Ø±Ø¶ Ø§Ù„Ø´Ø¨ÙƒØ©    
          </button>    
          <button class="btn btn-sm btn-outline-danger ms-2" onclick="clearAllData()">    
            <i class="bi bi-trash"></i> Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„    
          </button>    
        </div>    
      </div>    
      <div id="budgetsList" class="row"></div>    
    </div>    
    
    <div class="card p-3 mb-4 d-none" id="expensesCard">    
      <div class="d-flex justify-content-between align-items-center mb-3">    
        <h5 id="currentBudgetName" class="fw-bold mb-0"></h5>    
        <button class="btn btn-sm btn-outline-danger" onclick="closeBudget()">    
          <i class="bi bi-x-circle"></i> Ø¥ØºÙ„Ø§Ù‚    
        </button>    
      </div>    
          
      <div class="budget-summary">    
        <div class="row text-center">    
          <div class="col-4">    
            <h6>Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©</h6>    
            <h4 id="budgetTotalDisplay">0 Ø¬.Ø³</h4>    
          </div>    
          <div class="col-4">    
            <h6>Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</h6>    
            <h4 id="totalExpensesDisplay">0 Ø¬.Ø³</h4>    
          </div>    
          <div class="col-4">    
            <h6>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</h6>    
            <h4 id="remainingDisplay">0 Ø¬.Ø³</h4>    
          </div>    
        </div>    
        <div class="progress mt-2">    
          <div id="budgetProgress" class="progress-bar" role="progressbar" style="width: 0%"></div>    
        </div>    
        <div class="text-center mt-2 small" id="budgetPercentage">0%</div>    
      </div>    
    
      <ul class="nav nav-tabs mb-3" id="expensesTabs">    
        <li class="nav-item">    
          <a class="nav-link active" data-bs-toggle="tab" href="#addExpenseTab">Ø¥Ø¶Ø§ÙØ© Ù…ØµØ±ÙˆÙ</a>    
        </li>    
        <li class="nav-item">    
          <a class="nav-link" data-bs-toggle="tab" href="#expensesListTab">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</a>    
        </li>    
        <li class="nav-item">    
          <a class="nav-link" data-bs-toggle="tab" href="#chartsTab">Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</a>    
        </li>    
      </ul>    
    
      <div class="tab-content">    
        <div class="tab-pane fade show active" id="addExpenseTab">    
          <div class="row g-2 mb-3">    
            <div class="col-md-6">    
              <div class="input-group">    
                <span class="input-group-text"><i class="bi bi-pencil"></i></span>    
                <input id="expenseName" type="text" class="form-control" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ØµØ±ÙˆÙ">    
              </div>    
            </div>    
            <div class="col-md-4">    
              <div class="input-group">    
                <span class="input-group-text"><i class="bi bi-cash"></i></span>    
                <input id="expenseAmount" type="number" class="form-control" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº">    
              </div>    
            </div>    
            <div class="col-md-2">    
              <select id="expenseCategory" class="form-select">    
                <option value="Ø¹Ø§Ù…">Ø¹Ø§Ù…</option>    
                <option value="Ø·Ø¹Ø§Ù…">Ø·Ø¹Ø§Ù…</option>    
                <option value="Ù…ÙˆØ§ØµÙ„Ø§Øª">Ù…ÙˆØ§ØµÙ„Ø§Øª</option>    
                <option value="ØªØ³ÙˆÙ‚">ØªØ³ÙˆÙ‚</option>    
                <option value="ÙÙˆØ§ØªÙŠØ±">ÙÙˆØ§ØªÙŠØ±</option>    
                <option value="ØªØ±ÙÙŠÙ‡">ØªØ±ÙÙŠÙ‡</option>    
                <option value="ØµØ­Ø©">ØµØ­Ø©</option>    
                <option value="Ø£Ø®Ø±Ù‰">Ø£Ø®Ø±Ù‰</option>    
              </select>    
            </div>    
          </div>    
          <button class="btn btn-green w-100" onclick="addExpense()">    
            <i class="bi bi-plus-circle"></i> Ø¥Ø¶Ø§ÙØ© Ù…ØµØ±ÙˆÙ    
          </button>    
        </div>    
    
        <div class="tab-pane fade" id="expensesListTab">    
          <div class="d-flex justify-content-between align-items-center mb-3">    
            <h6 class="fw-bold mb-0">Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª:</h6>    
            <div class="input-group w-auto">    
              <input type="text" class="form-control form-control-sm" placeholder="Ø¨Ø­Ø«..." id="expenseSearch">    
              <button class="btn btn-outline-secondary btn-sm" type="button" onclick="filterExpenses()">    
                <i class="bi bi-search"></i>    
              </button>    
            </div>    
          </div>    
          <div id="expensesList"></div>    
        </div>    
    
        <div class="tab-pane fade" id="chartsTab">    
          <div class="chart-container">    
            <canvas id="expenseChartCanvas"></canvas>    
          </div>    
          <div class="text-center">    
            <button class="btn btn-outline-success me-2" onclick="generateReport()">    
              <i class="bi bi-file-earmark-pdf"></i> ØªÙˆÙ„ÙŠØ¯ ØªÙ‚Ø±ÙŠØ± PDF    
            </button>    
            <button class="btn btn-outline-primary" onclick="exportToExcel()">    
              <i class="bi bi-file-earmark-excel"></i> ØªØµØ¯ÙŠØ± Ø¥Ù„Ù‰ Excel    
            </button>    
          </div>    
        </div>    
      </div>    
    </div>    
  </div>    
    
  <div class="modal fade" id="editBudgetModal" tabindex="-1">    
    <div class="modal-dialog">    
      <div class="modal-content">    
        <div class="modal-header">    
          <h5 class="modal-title">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©</h5>    
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>    
        </div>    
        <div class="modal-body">    
          <div class="mb-3">    
            <label for="editBudgetLabel" class="form-label">Ø§Ø³Ù… Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©</label>    
            <input type="text" class="form-control" id="editBudgetLabel">    
          </div>    
          <div class="mb-3">    
            <label for="editBudgetTotal" class="form-label">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„ÙƒÙ„ÙŠ</label>    
            <input type="number" class="form-control" id="editBudgetTotal">    
          </div>    
        </div>    
        <div class="modal-footer">    
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ø¥Ù„ØºØ§Ø¡</button>    
          <button type="button" class="btn btn-green" onclick="saveBudgetEdit()">Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª</button>    
        </div>    
      </div>    
    </div>    
  </div>    
    
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>    
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>    
    
  <script>    
    let budgets = JSON.parse(localStorage.getItem('budgets')) || [];    
    let currentBudget = null;    
    let isGridView = false;    
    let expenseChart = null;    
    
    // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚    
    document.addEventListener('DOMContentLoaded', function() {    
      renderBudgets();    
          
      // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ÙŠ Ø§Ù„Ø£Ø­Ø¯Ø§Ø«    
      document.getElementById('expenseSearch').addEventListener('input', filterExpenses);    
      document.getElementById('expenseAmount').addEventListener('keypress', function(e) {    
        if (e.key === 'Enter') addExpense();    
      });    
          
      // Ù…Ø³ØªÙ…Ø¹ Ù„Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¨ÙŠÙ† Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ    
      const chartTab = document.querySelector('a[href="#chartsTab"]');    
      if (chartTab) {    
          chartTab.addEventListener('shown.bs.tab', function (e) {    
              if (currentBudget) {    
                  updateExpenseChart();    
              }    
          });    
      }    
    });    
    
    function saveData() {    
      localStorage.setItem('budgets', JSON.stringify(budgets));    
    }    
    
    function addBudget() {    
      const type = document.getElementById('budgetType').value;    
      const label = document.getElementById('budgetLabel').value.trim();    
      const total = parseFloat(document.getElementById('budgetTotal').value);    
    
      if (!label || isNaN(total) || total <= 0) {    
        Swal.fire('Ø®Ø·Ø£', 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… ÙˆÙ…Ø¨Ù„Øº ØµØ­ÙŠØ­', 'error');    
        return;    
      }    
    
      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø¨Ù†ÙØ³ Ø§Ù„Ø§Ø³Ù…    
      if (budgets.some(b => b.label === label)) {    
        Swal.fire('Ø®Ø·Ø£', 'ÙŠÙˆØ¬Ø¯ Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø¨Ù†ÙØ³ Ø§Ù„Ø§Ø³Ù… Ù…Ø³Ø¨Ù‚Ø§Ù‹', 'error');    
        return;    
      }    
    
      budgets.push({     
        id: Date.now(),     
        type,     
        label,     
        total,     
        expenses: [],    
        createdAt: new Date().toISOString()    
      });    
          
      saveData();    
      document.getElementById('budgetLabel').value = '';    
      document.getElementById('budgetTotal').value = '';    
      Swal.fire('ØªÙ… Ø§Ù„Ø­ÙØ¸', 'ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­ âœ…', 'success');    
      renderBudgets();    
    }    
    
    function renderBudgets() {    
      const list = document.getElementById('budgetsList');    
      list.innerHTML = '';    
    
      if (budgets.length === 0) {    
        list.innerHTML = `    
          <div class="empty-state">    
            <i class="bi bi-wallet2"></i>    
            <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ÙŠØ²Ø§Ù†ÙŠØ§Øª Ø¨Ø¹Ø¯.</p>    
            <p class="small">Ø§Ø¨Ø¯Ø£ Ø¨Ø¥Ù†Ø´Ø§Ø¡ Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø© Ù„Ø¥Ø¯Ø§Ø±Ø© Ù…ØµØ±ÙˆÙØ§ØªÙƒ</p>    
          </div>`;    
        return;    
      }    
    
      budgets.forEach(b => {    
        const totalExpenses = b.expenses.reduce((s, e) => s + e.amount, 0);    
        const remaining = b.total - totalExpenses;    
        // ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ø§Ù„Ù†Ø³Ø¨Ø© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ (Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª / Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ)    
        const percentage = Math.min(100, Math.round((totalExpenses / b.total) * 100));     
            
        const budgetCard = `    
          <div class="${isGridView ? 'col-md-6 col-lg-4 mb-3' : 'col-12 mb-3'}">    
            <div class="card h-100">    
              <div class="card-body">    
                <div class="d-flex justify-content-between align-items-start">    
                  <div>    
                    <h5 class="card-title">${b.label}</h5>    
                    <span class="badge bg-secondary">${b.type}</span>    
                    <div class="mt-2">    
                      <div class="progress">    
                        <div class="progress-bar ${percentage > 80 ? 'bg-danger' : percentage > 50 ? 'bg-warning' : 'bg-success'}"     
                             role="progressbar" style="width: ${percentage}%"></div>    
                      </div>    
                      <div class="small text-muted mt-1">${percentage}% Ù…Ø³ØªØ®Ø¯Ù…</div>    
                    </div>    
                  </div>    
                  <div class="dropdown">    
                    <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">    
                      <i class="bi bi-three-dots"></i>    
                    </button>    
                    <ul class="dropdown-menu">    
                      <li><a class="dropdown-item" href="#" onclick="openBudget(${b.id})"><i class="bi bi-eye"></i> ÙØªØ­</a></li>    
                      <li><a class="dropdown-item" href="#" onclick="editBudget(${b.id})"><i class="bi bi-pencil"></i> ØªØ¹Ø¯ÙŠÙ„</a></li>    
                      <li><hr class="dropdown-divider"></li>    
                      <li><a class="dropdown-item text-danger" href="#" onclick="deleteBudget(${b.id})"><i class="bi bi-trash"></i> Ø­Ø°Ù</a></li>    
                    </ul>    
                  </div>    
                </div>    
                <div class="row text-center mt-3">    
                  <div class="col-4">    
                    <div class="small text-muted">Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©</div>    
                    <div class="fw-bold">${b.total.toLocaleString()} Ø¬.Ø³</div>    
                  </div>    
                  <div class="col-4">    
                    <div class="small text-muted">Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</div>    
                    <div class="fw-bold text-danger">${totalExpenses.toLocaleString()} Ø¬.Ø³</div>    
                  </div>    
                  <div class="col-4">    
                    <div class="small text-muted">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</div>    
                    <div class="fw-bold ${remaining < 0 ? 'text-danger' : 'text-success'}">${remaining.toLocaleString()} Ø¬.Ø³</div>    
                  </div>    
                </div>    
                <div class="budget-actions">    
                  <button class="btn btn-sm btn-outline-primary" onclick="openBudget(${b.id})">    
                    <i class="bi bi-eye"></i> ÙØªØ­    
                  </button>    
                  <button class="btn btn-sm btn-outline-success" onclick="generateReport(${b.id})">    
                    <i class="bi bi-file-earmark-pdf"></i> ØªÙ‚Ø±ÙŠØ±    
                  </button>    
                </div>    
              </div>    
            </div>    
          </div>`;    
            
        list.innerHTML += budgetCard;    
      });    
    }    
    
    function toggleView() {    
      isGridView = !isGridView;    
      const btn = document.getElementById('toggleViewBtn');    
      btn.innerHTML = isGridView ?     
        '<i class="bi bi-list-ul"></i> Ø¹Ø±Ø¶ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©' :     
        '<i class="bi bi-grid"></i> Ø¹Ø±Ø¶ Ø§Ù„Ø´Ø¨ÙƒØ©';    
      renderBudgets();    
    }    
    
    function openBudget(id) {    
      currentBudget = budgets.find(b => b.id === id);    
      document.getElementById('expensesCard').classList.remove('d-none');    
      document.getElementById('currentBudgetName').innerText = currentBudget.label;    
      updateBudgetUI();    
          
      // ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø£ÙˆÙ„    
      const firstTabLink = document.querySelector('#expensesTabs a[href="#addExpenseTab"]');    
      if (firstTabLink) new bootstrap.Tab(firstTabLink).show();    
    }    
    
    function closeBudget() {    
      currentBudget = null;    
      document.getElementById('expensesCard').classList.add('d-none');    
      if (expenseChart) {    
        expenseChart.destroy();    
        expenseChart = null;    
      }    
      renderBudgets(); // Ù„ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ§Øª Ø¨Ø¹Ø¯ Ø§Ù„Ø¹ÙˆØ¯Ø©    
    }    
    
    function updateBudgetUI() {    
      if (!currentBudget) return;    
          
      const totalExpenses = currentBudget.expenses.reduce((s, e) => s + e.amount, 0);    
      const remaining = currentBudget.total - totalExpenses;    
      const percentage = Math.min(100, Math.round((totalExpenses / currentBudget.total) * 100));    
          
      // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù„Ø®Øµ    
      document.getElementById('budgetTotalDisplay').textContent = `${currentBudget.total.toLocaleString()} Ø¬.Ø³`;    
      document.getElementById('totalExpensesDisplay').textContent = `${totalExpenses.toLocaleString()} Ø¬.Ø³`;    
      document.getElementById('remainingDisplay').textContent = `${remaining.toLocaleString()} Ø¬.Ø³`;    
      document.getElementById('budgetPercentage').textContent = `${percentage}% Ù…Ø³ØªØ®Ø¯Ù…`;    
          
      // ØªØ­Ø¯ÙŠØ« Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù…    
      const progressBar = document.getElementById('budgetProgress');    
      progressBar.style.width = `${percentage}%`;    
      progressBar.className = `progress-bar ${percentage > 80 ? 'bg-danger' : percentage > 50 ? 'bg-warning' : 'bg-success'}`;    
          
      // ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª    
      renderExpensesList();    
          
      // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ (Ø³ÙŠØªØ­Ø¯Ø« ÙÙ‚Ø· Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØªØ¨ÙˆÙŠØ¨)    
      // updateExpenseChart();     
    }    
    
    function renderExpensesList() {    
      const list = document.getElementById('expensesList');    
      list.innerHTML = '';    
    
      if (!currentBudget || currentBudget.expenses.length === 0) {    
        list.innerHTML = `    
          <div class="empty-state">    
            <i class="bi bi-receipt"></i>    
            <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ØµØ±ÙˆÙØ§Øª Ù…Ø³Ø¬Ù„Ø© Ø¨Ø¹Ø¯.</p>    
          </div>`;    
        return;    
      }    
    
      currentBudget.expenses.forEach((e, i) => {    
        // Ù„ØªØ¬Ù†Ø¨ Ø®Ø·Ø£ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø¥Ø°Ø§ ÙƒØ§Ù† ØºÙŠØ± Ù…Ø­Ø¯Ø¯    
        const date = e.date ? new Date(e.date).toLocaleDateString('ar-EG', { year: 'numeric', month: 'short', day: 'numeric' }) : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';    
        list.innerHTML += `    
          <div class="expense-item">    
            <div>    
              <div class="d-flex align-items-center">    
                <span class="me-2">${e.name}</span>    
                <span class="category-badge">${e.category || 'Ø¹Ø§Ù…'}</span>    
              </div>    
              <div class="expense-date">${date}</div>    
            </div>    
            <div class="d-flex align-items-center">    
              <span class="text-danger fw-bold me-2">${e.amount.toLocaleString()} Ø¬.Ø³</span>    
              <button class="btn btn-sm btn-outline-danger" onclick="deleteExpense(${i})">    
                <i class="bi bi-trash"></i>    
              </button>    
            </div>    
          </div>`;    
      });    
    }    
    
    function filterExpenses() {    
      const searchTerm = document.getElementById('expenseSearch').value.toLowerCase();    
      const expenseItems = document.querySelectorAll('#expensesList .expense-item');    
          
      expenseItems.forEach(item => {    
        const text = item.textContent.toLowerCase();    
        item.style.display = text.includes(searchTerm) ? 'flex' : 'none';    
      });    
    }    
    
    function addExpense() {    
      if (!currentBudget) return;    
    
      const name = document.getElementById('expenseName').value.trim();    
      const amount = parseFloat(document.getElementById('expenseAmount').value);    
      const category = document.getElementById('expenseCategory').value;    
    
      if (!name || isNaN(amount) || amount <= 0) {    
        Swal.fire('Ø®Ø·Ø£', 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… ÙˆÙ…Ø¨Ù„Øº ØµØ­ÙŠØ­', 'error');    
        return;    
      }    
    
      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¯Ù… ØªØ¬Ø§ÙˆØ² Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©    
      const totalExpenses = currentBudget.expenses.reduce((s, e) => s + e.amount, 0);    
      if (totalExpenses + amount > currentBudget.total) {    
        // ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ù…Ø§ Ù…Ù†Ø¹ Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø£Ùˆ ØªØ­Ø°ÙŠØ±Ù‡    
        Swal.fire('ØªØ­Ø°ÙŠØ±', `Ù‡Ø°Ø§ Ø§Ù„Ù…ØµØ±ÙˆÙ Ø³ÙŠØªØ¬Ø§ÙˆØ² Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© Ø¨Ù€ ${((totalExpenses + amount) - currentBudget.total).toLocaleString()} Ø¬.Ø³`, 'warning');    
        // Ø¥Ø°Ø§ Ø£Ø±Ø¯Øª Ø§Ù„Ù…Ù†Ø¹: return;    
      }    
    
      currentBudget.expenses.push({     
        name,     
        amount,     
        category,    
        date: new Date().toISOString()    
      });    
          
      saveData();    
      document.getElementById('expenseName').value = '';    
      document.getElementById('expenseAmount').value = '';    
      updateBudgetUI();    
      Swal.fire('ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ©', '', 'success');    
          
      // Ù†Ù‚Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ø¨Ø¹Ø¯ Ø§Ù„Ø¥Ø¶Ø§ÙØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)    
      const listTabLink = document.querySelector('#expensesTabs a[href="#expensesListTab"]');    
      if (listTabLink) new bootstrap.Tab(listTabLink).show();    
    }    
    
    function deleteExpense(index) {    
      Swal.fire({    
        title: 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ',    
        text: "Ù„Ù† ØªØªÙ…ÙƒÙ† Ù…Ù† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡!",    
        icon: 'warning',    
        showCancelButton: true,    
        confirmButtonColor: '#d33',    
        cancelButtonColor: '#6c757d',    
        confirmButtonText: 'Ù†Ø¹Ù…ØŒ Ø§Ø­Ø°Ù!',    
        cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡'    
      }).then((result) => {    
        if (result.isConfirmed) {    
          currentBudget.expenses.splice(index, 1);    
          saveData();    
          updateBudgetUI();    
          Swal.fire('ØªÙ… Ø§Ù„Ø­Ø°Ù âœ…', '', 'success');    
        }    
      });    
    }    
    
    function editBudget(id) {    
      const budget = budgets.find(b => b.id === id);    
      if (!budget) return;    
          
      document.getElementById('editBudgetLabel').value = budget.label;    
      document.getElementById('editBudgetTotal').value = budget.total;    
          
      // ØªØ®Ø²ÙŠÙ† Ù…Ø¹Ø±Ù Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù„Ù„ØªØ¹Ø¯ÙŠÙ„    
      const modalElement = document.getElementById('editBudgetModal');    
      modalElement.dataset.budgetId = id;    
          
      const modal = new bootstrap.Modal(modalElement);    
      modal.show();    
    }    
    
    function saveBudgetEdit() {    
      const modalElement = document.getElementById('editBudgetModal');    
      const budgetId = parseInt(modalElement.dataset.budgetId);    
      const budget = budgets.find(b => b.id === budgetId);    
      if (!budget) return;    
          
      const newLabel = document.getElementById('editBudgetLabel').value.trim();    
      const newTotal = parseFloat(document.getElementById('editBudgetTotal').value);    
          
      if (!newLabel || isNaN(newTotal) || newTotal <= 0) {    
        Swal.fire('Ø®Ø·Ø£', 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… ÙˆÙ…Ø¨Ù„Øº ØµØ­ÙŠØ­', 'error');    
        return;    
      }    
          
      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø¨Ù†ÙØ³ Ø§Ù„Ø§Ø³Ù… (Ø¨Ø§Ø³ØªØ«Ù†Ø§Ø¡ Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©)    
      if (budgets.some(b => b.label === newLabel && b.id !== budgetId)) {    
        Swal.fire('Ø®Ø·Ø£', 'ÙŠÙˆØ¬Ø¯ Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø¨Ù†ÙØ³ Ø§Ù„Ø§Ø³Ù… Ù…Ø³Ø¨Ù‚Ø§Ù‹', 'error');    
        return;    
      }    
          
      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¯Ù… ØªØ¬Ø§ÙˆØ² Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ù„Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¬Ø¯ÙŠØ¯    
      const totalExpenses = budget.expenses.reduce((s, e) => s + e.amount, 0);    
      if (totalExpenses > newTotal) {    
          Swal.fire('Ø®Ø·Ø£', `Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„ÙƒÙ„ÙŠ Ø§Ù„Ø¬Ø¯ÙŠØ¯ (${newTotal.toLocaleString()} Ø¬.Ø³) Ø£Ù‚Ù„ Ù…Ù† Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ© (${totalExpenses.toLocaleString()} Ø¬.Ø³). ÙŠØ±Ø¬Ù‰ Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„ÙƒÙ„ÙŠ.`, 'error');    
          return;    
      }    
    
      budget.label = newLabel;    
      budget.total = newTotal;    
          
      saveData();    
          
      // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø§Ù„Ù…ÙØªÙˆØ­Ø© Ù‡ÙŠ Ù†ÙØ³Ù‡Ø§ Ø§Ù„ØªÙŠ ØªÙ… ØªØ¹Ø¯ÙŠÙ„Ù‡Ø§    
      if (currentBudget && currentBudget.id === budgetId) {    
        currentBudget = budget;    
        updateBudgetUI();    
      }    
          
      renderBudgets();    
          
      bootstrap.Modal.getInstance(modalElement).hide();    
      Swal.fire('ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„', 'ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­ âœ…', 'success');    
    }    
    
    function deleteBudget(id) {    
      Swal.fire({    
        title: 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ',    
        text: "Ø³ÙŠØªÙ… Ø­Ø°Ù Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© ÙˆØ¬Ù…ÙŠØ¹ Ù…ØµØ±ÙˆÙØ§ØªÙ‡Ø§!",    
        icon: 'warning',    
        showCancelButton: true,    
        confirmButtonColor: '#d33',    
        cancelButtonColor: '#6c757d',    
        confirmButtonText: 'Ù†Ø¹Ù…ØŒ Ø§Ø­Ø°Ù!',    
        cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡'    
      }).then((result) => {    
        if (result.isConfirmed) {    
          budgets = budgets.filter(b => b.id !== id);    
          saveData();    
              
          // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ© Ù‡ÙŠ Ø§Ù„Ù…ÙØªÙˆØ­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹    
          if (currentBudget && currentBudget.id === id) {    
            closeBudget();    
          }    
              
          renderBudgets();    
          Swal.fire('ØªÙ… Ø§Ù„Ø­Ø°Ù âœ…', 'ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­', 'success');    
        }    
      });    
    }    
    
    function clearAllData() {    
      Swal.fire({    
        title: 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ',    
        text: "Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ§Øª ÙˆØ§Ù„Ù…ØµØ±ÙˆÙØ§Øª! Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.",    
        icon: 'warning',    
        showCancelButton: true,    
        confirmButtonColor: '#d33',    
        cancelButtonColor: '#6c757d',    
        confirmButtonText: 'Ù†Ø¹Ù…ØŒ Ø§Ø­Ø°Ù Ø§Ù„ÙƒÙ„!',    
        cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡'    
      }).then((result) => {    
        if (result.isConfirmed) {    
          budgets = [];    
          saveData();    
          closeBudget();    
          renderBudgets();    
          Swal.fire('ØªÙ… Ø§Ù„Ù…Ø³Ø­ âœ…', 'ØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­', 'success');    
        }    
      });    
    }    
    
    function updateExpenseChart() {    
      const canvasElement = document.getElementById('expenseChartCanvas');    
      if (!canvasElement) return;    
    
      const ctx = canvasElement.getContext('2d');    
          
      // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø±Ø³Ù… Ø¨ÙŠØ§Ù†ÙŠ Ù…ÙˆØ¬ÙˆØ¯ØŒ Ù‚Ù… Ø¨ØªØ¯Ù…ÙŠØ±Ù‡ Ø£ÙˆÙ„Ø§Ù‹    
      if (expenseChart) {    
        expenseChart.destroy();    
      }    
          
      // ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ø­Ø³Ø¨ Ø§Ù„ÙØ¦Ø©    
      const categories = {};    
      currentBudget.expenses.forEach(expense => {    
        const category = expense.category || 'Ø¹Ø§Ù…';    
        if (!categories[category]) {    
          categories[category] = 0;    
        }    
        categories[category] += expense.amount;    
      });    
          
      const categoryNames = Object.keys(categories);    
      const categoryAmounts = Object.values(categories);    
          
      // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ    
      expenseChart = new Chart(ctx, {    
        type: 'doughnut',    
        data: {    
          labels: categoryNames,    
          datasets: [{    
            data: categoryAmounts,    
            backgroundColor: [    
              '#198754', '#20c997', '#0dcaf0', '#6f42c1',     
              '#d63384', '#fd7e14', '#ffc107', '#6c757d'    
            ],    
            borderWidth: 1    
          }]    
        },    
        options: {    
          responsive: true,    
          maintainAspectRatio: false,    
          plugins: {    
            legend: {    
              position: 'bottom',    
              rtl: true, // Ù…Ù‡Ù… Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©    
              labels: {    
                font: {    
                  family: 'Cairo',    
                }    
              }    
            },    
            tooltip: {    
              rtl: true,    
              callbacks: {    
                label: function(context) {    
                  const value = context.raw;    
                  const total = context.dataset.data.reduce((a, b) => a + b, 0);    
                  const percentage = Math.round((value / total) * 100);    
                  // Ø§Ø³ØªØ®Ø¯Ø§Ù… toLocaleString() Ù„ØªØ­Ø³ÙŠÙ† ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø£Ø±Ù‚Ø§Ù…    
                  return `${context.label}: ${value.toLocaleString()} Ø¬.Ø³ (${percentage}%)`;    
                }    
              },    
              titleFont: { family: 'Cairo' },    
              bodyFont: { family: 'Cairo' }    
            }    
          }    
        }    
      });    
    }    
    
async function generateReport(budgetId = null) {    
  const budget = budgetId ? budgets.find(b => b.id === budgetId) : currentBudget;    
  if (!budget) {    
    Swal.fire('Ø®Ø·Ø£', 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø£ÙˆÙ„Ø§Ù‹.', 'error');    
    return;    
  }    
      
  const totalExpenses = budget.expenses.reduce((s, e) => s + e.amount, 0);    
  const remaining = budget.total - totalExpenses;    
  const percentage = Math.min(100, Math.round((totalExpenses / budget.total) * 100));    
      
  // ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ø­Ø³Ø¨ Ø§Ù„ÙØ¦Ø©    
  const categories = {};    
  budget.expenses.forEach(expense => {    
    const category = expense.category || 'Ø¹Ø§Ù…';    
    if (!categories[category]) {    
      categories[category] = 0;    
    }    
    categories[category] += expense.amount;    
  });    
      
  // Ø¥Ù†Ø´Ø§Ø¡ HTML Ù„Ù„ØªÙ‚Ø±ÙŠØ±    
  // Ù…Ù„Ø§Ø­Ø¸Ø©: ØªÙ… ØªØ¹Ø¯ÙŠÙ„ style Ù„Ø¶Ù…Ø§Ù† Ø¸Ù‡ÙˆØ± Ø§Ù„Ø®Ø· 'Cairo'    
  const reportHTML = `    
    <div id="reportContent" dir="rtl" style="font-family: 'Cairo', sans-serif; padding: 20px; background: white; width: 780px;">    
      <h1 style="text-align: center; color: #198754; margin-bottom: 20px; font-weight: 700;">ØªÙ‚Ø±ÙŠØ± Ù…ÙŠØ²Ø§Ù†ÙŠØ© ${budget.label}</h1>    
          
      <div style="margin-bottom: 20px; border-bottom: 1px dashed #ccc; padding-bottom: 15px;">    
        <p style="margin: 5px 0;"><strong>Ø§Ù„Ù†ÙˆØ¹:</strong> ${budget.type}</p>    
        <p style="margin: 5px 0;"><strong>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡:</strong> ${new Date(budget.createdAt).toLocaleDateString('ar-EG', { year: 'numeric', month: 'long', day: 'numeric' })}</p>    
      </div>    
          
      <div style="margin-bottom: 30px;">    
        <h3 style="color: #198754; border-bottom: 2px solid #198754; padding-bottom: 5px; font-weight: 700;">Ù…Ù„Ø®Øµ Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©</h3>    
        <table style="width: 100%; border-collapse: collapse; margin-top: 10px;">    
          <tr style="background-color: #d1e7dd;">    
            <th style="border: 1px solid #ddd; padding: 10px; text-align: right; font-weight: 700; width: 50%;">Ø§Ù„Ø¨Ù†Ø¯</th>    
            <th style="border: 1px solid #ddd; padding: 10px; text-align: right; font-weight: 700; width: 50%;">Ø§Ù„Ù‚ÙŠÙ…Ø©</th>    
          </tr>    
          <tr>    
            <td style="border: 1px solid #ddd; padding: 10px;"><strong>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„ÙƒÙ„ÙŠ</strong></td>    
            <td style="border: 1px solid #ddd; padding: 10px;"><strong>${budget.total.toLocaleString()} Ø¬.Ø³</strong></td>    
          </tr>    
          <tr>    
            <td style="border: 1px solid #ddd; padding: 10px;"><strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</strong></td>    
            <td style="border: 1px solid #ddd; padding: 10px; color: #dc3545;">${totalExpenses.toLocaleString()} Ø¬.Ø³</td>    
          </tr>    
          <tr>    
            <td style="border: 1px solid #ddd; padding: 10px;"><strong>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</strong></td>    
            <td style="border: 1px solid #ddd; padding: 10px; color: ${remaining >= 0 ? '#198754' : '#dc3545'};">${remaining.toLocaleString()} Ø¬.Ø³</td>    
          </tr>    
          <tr>    
            <td style="border: 1px solid #ddd; padding: 10px;"><strong>Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…Ø©</strong></td>    
            <td style="border: 1px solid #ddd; padding: 10px; color: ${percentage > 80 ? '#dc3545' : percentage > 50 ? '#ffc107' : '#198754'};">${percentage}%</td>    
          </tr>    
        </table>    
      </div>    
    
      ${Object.keys(categories).length > 0 ? `    
      <div style="margin-bottom: 30px;">    
        <h3 style="color: #198754; border-bottom: 2px solid #198754; padding-bottom: 5px; font-weight: 700;">Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ø­Ø³Ø¨ Ø§Ù„ÙØ¦Ø©</h3>    
        <table style="width: 100%; border-collapse: collapse; margin-top: 10px;">    
          <tr style="background-color: #d1e7dd;">    
            <th style="border: 1px solid #ddd; padding: 10px; text-align: right; font-weight: 700;">Ø§Ù„ÙØ¦Ø©</th>    
            <th style="border: 1px solid #ddd; padding: 10px; text-align: right; font-weight: 700;">Ø§Ù„Ù…Ø¨Ù„Øº (Ø¬.Ø³)</th>    
          </tr>    
          ${Object.entries(categories).map(([category, amount]) => `    
            <tr>    
              <td style="border: 1px solid #ddd; padding: 10px;">${category}</td>    
              <td style="border: 1px solid #ddd; padding: 10px;">${amount.toLocaleString()} Ø¬.Ø³</td>    
            </tr>    
          `).join('')}    
        </table>    
      </div>    
      ` : ''}    
    
      ${budget.expenses.length > 0 ? `    
      <div style="margin-bottom: 30px;">    
        <h3 style="color: #198754; border-bottom: 2px solid #198754; padding-bottom: 5px; font-weight: 700;">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</h3>    
        <table style="width: 100%; border-collapse: collapse; margin-top: 10px;">    
          <tr style="background-color: #d1e7dd;">    
            <th style="border: 1px solid #ddd; padding: 10px; text-align: right; font-weight: 700;">Ø§Ø³Ù… Ø§Ù„Ù…ØµØ±ÙˆÙ</th>    
            <th style="border: 1px solid #ddd; padding: 10px; text-align: right; font-weight: 700;">Ø§Ù„ÙØ¦Ø©</th>    
            <th style="border: 1px solid #ddd; padding: 10px; text-align: right; font-weight: 700;">Ø§Ù„Ù…Ø¨Ù„Øº (Ø¬.Ø³)</th>    
            <th style="border: 1px solid #ddd; padding: 10px; text-align: right; font-weight: 700;">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>    
          </tr>    
          ${budget.expenses.map(e => `    
            <tr>    
              <td style="border: 1px solid #ddd; padding: 10px;">${e.name}</td>    
              <td style="border: 1px solid #ddd; padding: 10px;">${e.category || 'Ø¹Ø§Ù…'}</td>    
              <td style="border: 1px solid #ddd; padding: 10px;">${e.amount.toLocaleString()} Ø¬.Ø³</td>    
              <td style="border: 1px solid #ddd; padding: 10px;">${e.date ? new Date(e.date).toLocaleDateString('ar-EG', { year: 'numeric', month: 'short', day: 'numeric' }) : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</td>    
            </tr>    
          `).join('')}    
        </table>    
      </div>    
      ` : `    
      <div style="margin-bottom: 30px; text-align: center; padding: 20px; background: #f8f9fa; border-radius: 5px; border: 1px dashed #ddd;">    
        <p style="color: #6c757d; margin: 0;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ØµØ±ÙˆÙØ§Øª Ù…Ø³Ø¬Ù„Ø© Ø¨Ø¹Ø¯</p>    
      </div>    
      `}    
    
      <div style="text-align: center; margin-top: 40px; padding-top: 20px; border-top: 1px solid #ddd;">    
        <p style="color: #888; font-size: 12px; margin: 0;">    
          ØªÙ… ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¨ÙˆØ§Ø³Ø·Ø© ØªØ·Ø¨ÙŠÙ‚ Ø¥Ø¯Ø§Ø±Ø© Ù…ØµØ§Ø±ÙŠÙ Ø§Ù„Ø¨ÙŠØª ÙÙŠ: ${new Date().toLocaleString('ar-EG')}    
        </p>    
      </div>    
    </div>    
  `;    
      
  // Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù†ØµØ± Ù…Ø¤Ù‚Øª Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø±ÙŠØ±    
  const tempDiv = document.createElement('div');    
  tempDiv.innerHTML = reportHTML;    
  tempDiv.style.position = 'absolute'; // Ø§Ø³ØªØ®Ø¯Ù… absolute Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† fixed Ù„ØªØ¬Ù†Ø¨ Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„Ø¹Ø±Ø¶    
  tempDiv.style.left = '-9999px';    
  tempDiv.style.top = '0';    
  tempDiv.style.background = 'white';    
  tempDiv.style.zIndex = '9999';    
  document.body.appendChild(tempDiv);    
      
  try {    
    // Ø¥Ø¸Ù‡Ø§Ø± loading    
    Swal.fire({    
      title: 'Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªÙ‚Ø±ÙŠØ±...',    
      text: 'ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±ØŒ Ù‚Ø¯ ÙŠØ³ØªØºØ±Ù‚ Ø§Ù„Ø£Ù…Ø± Ø¨Ø¹Ø¶ Ø§Ù„Ø«ÙˆØ§Ù†ÙŠ.',    
      allowOutsideClick: false,    
      didOpen: () => {    
        Swal.showLoading();    
      }    
    });    
        
    // Ø§Ø³ØªØ®Ø¯Ø§Ù… html2canvas Ù„Ø§Ù„ØªÙ‚Ø§Ø· Ø§Ù„ØµÙˆØ±Ø©    
    const canvas = await html2canvas(tempDiv.querySelector('#reportContent'), {    
      scale: 2, // Ù„Ø²ÙŠØ§Ø¯Ø© Ø¬ÙˆØ¯Ø© Ø§Ù„ØµÙˆØ±Ø©    
      useCORS: true,    
      logging: false,    
      width: 780, // Ù†ÙØ³ Ø¹Ø±Ø¶ Ø§Ù„Ø­Ø§ÙˆÙŠØ©    
    });    
        
    // ØªØ­ÙˆÙŠÙ„ Canvas Ø¥Ù„Ù‰ PDF    
    const { jsPDF } = window.jspdf;    
    const pdf = new jsPDF('p', 'mm', 'a4');    
        
    const imgData = canvas.toDataURL('image/png');    
    const pdfWidth = pdf.internal.pageSize.getWidth();    
    const pdfHeight = pdf.internal.pageSize.getHeight();    
        
    // Ø­Ø³Ø§Ø¨ Ø£Ø¨Ø¹Ø§Ø¯ Ø§Ù„ØµÙˆØ±Ø© Ù…Ø¹ Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„ØªÙ†Ø§Ø³Ø¨    
    const imgProps = pdf.getImageProperties(imgData);    
    const imgWidth = pdfWidth; // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¹Ø±Ø¶ Ø§Ù„ØµÙØ­Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ (210mm)    
    const imgHeight = (imgProps.height * imgWidth) / imgProps.width;    
    let heightLeft = imgHeight;    
    let position = 0;    
    const margin = 5; // Ù‡Ø§Ù…Ø´ Ø¨Ø³ÙŠØ·    
    
    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØµÙˆØ±Ø© Ù„Ø¹Ø¯Ø© ØµÙØ­Ø§Øª Ø¥Ø°Ø§ Ù„Ø²Ù… Ø§Ù„Ø£Ù…Ø±    
    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);    
    heightLeft -= pdfHeight;    
    
    while (heightLeft >= 0) {    
      position = heightLeft - imgHeight;    
      pdf.addPage();    
      pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);    
      heightLeft -= pdfHeight;    
    }    
        
    // Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ù    
    pdf.save(`ØªÙ‚Ø±ÙŠØ±-${budget.label}.pdf`);    
        
    // Ø¥ØºÙ„Ø§Ù‚ loading    
    Swal.close();    
    Swal.fire('ØªÙ… Ø§Ù„ØªØµØ¯ÙŠØ±', 'ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¨Ù†Ø¬Ø§Ø­ âœ…', 'success');    
        
  } catch (error) {    
    console.error('Error generating PDF:', error);    
    Swal.fire('Ø®Ø·Ø£', 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªÙ‚Ø±ÙŠØ±: ' + error.message, 'error');    
  } finally {    
    // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¹Ù†ØµØ± Ø§Ù„Ù…Ø¤Ù‚Øª    
    document.body.removeChild(tempDiv);    
  }    
}    
    
    function exportToExcel() {    
      if (!currentBudget) {    
        Swal.fire('Ø®Ø·Ø£', 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø£ÙˆÙ„Ø§Ù‹.', 'error');    
        return;    
      }    
          
      let csvContent = "data:text/csv;charset=utf-8,\uFEFF";    
          
      // Ø±Ø£Ø³ Ø§Ù„Ø¬Ø¯ÙˆÙ„    
      csvContent += "Ø§Ø³Ù… Ø§Ù„Ù…ØµØ±ÙˆÙ,Ø§Ù„ÙØ¦Ø©,Ø§Ù„Ù…Ø¨Ù„Øº (Ø¬.Ø³),Ø§Ù„ØªØ§Ø±ÙŠØ®\n";    
          
      // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ø¯ÙˆÙ„    
      currentBudget.expenses.forEach(expense => {    
        const date = expense.date ? new Date(expense.date).toLocaleDateString('ar-EG') : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';    
        // ÙŠÙØ¶Ù„ Ø¹Ø¯Ù… Ø§Ø³ØªØ®Ø¯Ø§Ù… toLocaleString ÙÙŠ Ù…Ù„ÙØ§Øª CSV Ù„Ø£Ù†Ù‡ Ù‚Ø¯ ÙŠØ¶ÙŠÙ ÙÙˆØ§ØµÙ„ Ø¹Ø´Ø±ÙŠØ© ØºÙŠØ± Ù…Ø±ØºÙˆØ¨Ø©    
        csvContent += `"${expense.name}","${expense.category || 'Ø¹Ø§Ù…'}","${expense.amount}","${date}"\n`;    
      });    
          
      // Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø§Ø¨Ø· Ø§Ù„ØªØ­Ù…ÙŠÙ„    
      const encodedUri = encodeURI(csvContent);    
      const link = document.createElement("a");    
      link.setAttribute("href", encodedUri);    
      link.setAttribute("download", `Ù…ØµØ±ÙˆÙØ§Øª-${currentBudget.label}.csv`);    
      document.body.appendChild(link);    
          
      // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù    
      link.click();    
      document.body.removeChild(link);    
          
      Swal.fire('ØªÙ… Ø§Ù„ØªØµØ¯ÙŠØ±', 'ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ø¥Ù„Ù‰ Ù…Ù„Ù CSV Ø¨Ù†Ø¬Ø§Ø­ âœ…', 'success');    
    }    
  </script>    
</body>    
</html>    
